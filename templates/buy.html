<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fid_Dawg Hotspot Login üåê</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="/static/wifi-signal.png">
</head>
<body>
    <header>
        <div class="dropdown">
            <button>Help</button>
            <div class="dropdown-content">
                For Assistance,Contact Us:
                <p>Fid: <a href="tel:+254746919779">+254746919779</a></p>
                <p>June: <a href="tel:+254769556367">+254769556367</a></p>
            </div>
        </div>
    </header>

    <div class="container">
        <h1>Buy a Voucher</h1>
        <p>Select a voucher plan below:</p>

        <!-- Voucher Buttons -->
        <div class="voucher-options">
            <button onclick="buyVoucher('1', '1 GB', '1 Hour')">1 Ksh - 1 GB for 1 Hour</button>
            <button onclick="buyVoucher('35', '3 GB', '3 Hours')">35 Ksh - 3 GB for 3 Hours</button>
            <button onclick="buyVoucher('45', '6 GB', '12 Hours')">45 Ksh - 6 GB for 12 Hours</button>
            <button onclick="buyVoucher('60', '10 GB', '24 Hours')">60 Ksh - 10 GB for 24 Hours</button>
            <button onclick="buyVoucher('1000', 'Unlimited', '1 Month')">1000 Ksh - Unlimited for 1 Month</button>
        </div>

        <!-- Phone Number Input -->
        <div id="phone-input-section" style="display:none;">
            <h2>Enter Your Phone Number</h2>
             <form id="phoneForm" onsubmit="submitPhoneNumber(event)">
                <label for="phoneNumber">Phone Number:</label>
                <input type="tel" id="phoneNumber" placeholder="Enter your phone number" required
                       pattern="^\+254(7|1)[0-9]{8}$"
                       value="+254"
                       maxlength="13"
                       title="Phone number must be in format +254XXXXXXXXX"
                       minlength="13">
                <span id="phoneError" style="color: red; display: none;">Please enter a valid phone number in the format +254XXXXXXXXX.</span>
                <input type="hidden" id="voucherAmount" name="amount">
                <input type="hidden" id="voucherData" name="data_plan">
                <input type="hidden" id="voucherDuration" name="duration">
                <input type="hidden" id="userType" name="user_type" value="guest">
                <button type="submit">Buy Voucher</button>
            </form>
        </div>

        <hr>

        <!-- Login Form -->
        <h1>Login to Fid_Dawg Wi-Fi</h1>
        <form id="loginForm">
            <label for="transaction_reference">Enter Voucher Code:</label>
            <input type="text" id="transaction_reference" name="transaction_reference" placeholder="Voucher Code " required>
            <button type="submit" id="loginButton" disabled>Login</button>
        </form>
    </div>

    <script>
    /**
     * Display voucher form and pre-fill its data
     */
    function buyVoucher(amount, data, duration) {
        console.log("Buying voucher with:", { amount, data, duration }); // Debug log

        // Ensure phone input section is visible
        document.getElementById('phone-input-section').style.display = 'block';

        // Assign values explicitly
        document.getElementById('voucherAmount').value = amount.toString();
        document.getElementById('voucherData').value = data;
        document.getElementById('voucherDuration').value = duration;

        // Debugging logs to verify correct values
        console.log("Set values:", {
            voucherAmount: document.getElementById('voucherAmount').value,
            voucherData: document.getElementById('voucherData').value,
            voucherDuration: document.getElementById('voucherDuration').value
        });
    }

    /**
     * Utility: Sanitize input to remove unnecessary characters
     */
    function sanitizeInput(inputValue) {
        return inputValue.replace(/[^a-zA-Z0-9+:\s]/g, "").trim();
    }

    /**
     * Common Fetch Utility
     */
    async function postRequest(url, payload) {
        try {
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "An error occurred.");
            }

            return data;
        } catch (err) {
            console.error("Request Failed:", err.message);
            alert("Error: " + err.message);
            throw err;
        }
    }

    /**
     * Handle phone number submission for voucher purchase
     */
    async function submitPhoneNumber(event) {
        console.log("submitPhoneNumber triggered");
        event.preventDefault();
        console.log("submitPhoneNumber event:", event);

          // Check if the request has already been sent
    if (window.requestSent) {
        console.log("Request already sent. Skipping...");
        return;
    }

    // Get the input values
    const phoneNumberInput = document.getElementById("phoneNumber").value;
    const voucherAmount = document.getElementById("voucherAmount").value;
    const voucherData = document.getElementById("voucherData").value;
    const voucherDuration = document.getElementById("voucherDuration").value;
    const userType = document.getElementById("userType").value;

    // Sanitize the phone number input
    const phoneNumber = sanitizeInput(phoneNumberInput);

    // Validate the phone number format
    if (!phoneNumber.match(/^\+254(7|1)[0-9]{8}$/)) {
        alert("Please enter a valid phone number in the format +254XXXXXXXXX.");
        return;
    }

    // Create the payload
    const payload = {
        phone_number: phoneNumber.replace("+", ""),
        amount: parseInt(voucherAmount, 10),
        voucher_data: sanitizeInput(voucherData),
        voucher_duration: sanitizeInput(voucherDuration),
        user_type: sanitizeInput(userType),
    };

    // Disable the submit button to prevent multiple submissions
    const submitButton = document.querySelector("button[type='submit']");
    if (submitButton) submitButton.disabled = true;

    // Flag the request as sent
    window.requestSent = true;

    console.log("Request Payload:", payload); // Log payload for debugging

    try {
        // Send the request
        const result = await postRequest("/mpesa/buy-voucher", payload);

        // Show success message
        alert("Voucher purchase successful! " + result.message);
    } catch (error) {
        // Handle errors
        alert("Error: " + error.message);
    } finally {
        // Reset the request flag and re-enable the button after request completion
        window.requestSent = false;
        if (submitButton) submitButton.disabled = false;
    }
}

    /**
     * Handle voucher login
     */
    async function submitVoucherCode(event) {
        event.preventDefault();

        const voucherCode = document.getElementById("transaction_reference").value.trim();

        if (!voucherCode) {
            alert("Please enter a valid voucher code.");
            return;
        }

        const payload = { transaction_reference: voucherCode };

        try {
            const result = await postRequest("/mpesa/validate", payload);
            alert("Login successful!");
            window.location.href = "/success";
        } catch (error) {
            alert("Error: " + error.message);
        }
    }

    // Attach event listeners directly to the forms
    const loginForm = document.getElementById('loginForm');


    if (loginForm) loginForm.addEventListener('submit', submitVoucherCode);
</script>

</body>
<footer>
    <p><span>
        ¬© 2025 Fid_Dawg,&nbsp;Inc.
      </span></p>
</footer>
</html>
